<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>百万格子 · 简洁版</title>
  <style>
    :root { --bg:#0b0c0f; --panel:#12141a; --border:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --green:#10b981; --amber:#f59e0b; --red:#ef4444 }
    *{box-sizing:border-box} html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,Helvetica,Arial}
    .shell{display:grid;grid-template-rows:56px 1fr;height:100%}
    header{display:flex;align-items:center;justify-content:space-between;padding:0 12px;border-bottom:1px solid var(--border);background:#0e1116}
    .title{font-weight:700;letter-spacing:.2px}
    .stats{display:flex;gap:12px;color:var(--muted);font-size:12px}
    .main{display:grid;grid-template-columns:1fr 360px;gap:10px;padding:10px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px}
    .map{position:relative;display:grid;grid-template-rows:1fr auto;overflow:hidden}
    canvas{width:100%;height:100%;display:block;cursor:crosshair}
    .legend{display:flex;gap:12px;padding:8px 10px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px}
    .side{display:grid;grid-template-rows:auto auto 1fr;gap:10px}
    .card{padding:10px;border-bottom:1px solid var(--border)}
    .field{display:grid;gap:6px;margin-top:8px}
    .input{background:#1a1f29;border:1px solid #263043;color:var(--text);border-radius:8px;padding:8px;font-size:13px;width:100%}
    .btn{background:#1a1f29;color:var(--text);border:1px solid #263043;border-radius:8px;height:32px;padding:0 10px;font-size:13px;cursor:pointer}
    .btn:hover{background:#242a33}
    .row{display:flex;gap:6px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}
    .code{background:#0e1116;border:1px solid #1f2937;border-radius:8px;padding:8px;font-size:12px;color:#cbd5e1;word-break:break-all}
    .ok{color:#10b981} .fail{color:#ef4444}
  </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="title">百万格子 · 简洁版</div>
        <div class="stats"><div><span id="owned">0</span> 已认领</div><div><span id="sale">0</span> 在售</div></div>
      </header>
      <div class="main">
        <div class="panel map">
          <canvas id="grid"></canvas>
          <div class="legend">
            <span><span class="dot" style="background:var(--green)"></span>已认领</span>
            <span><span class="dot" style="background:var(--amber)"></span>在售</span>
          </div>
        </div>
        <div class="panel side">
          <div class="card">
            <div id="cell-title">未选择格子</div>
            <div class="muted" id="cell-sub">点击格子选择（默认 0.02 USDC）</div>
          </div>
          <div class="card">
            <div class="muted">支付配置</div>
            <div class="field">
              <input id="treasury" class="input" placeholder="收款地址（Base 链）">
              <div class="row">
                <input id="amount" class="input" style="max-width:120px" value="0.02" placeholder="USDC">
                <input id="txhash" class="input" placeholder="交易哈希（可选）">
              </div>
              <div class="row">
                <button id="gen-awal" class="btn">生成 Awal</button>
                <button id="copy-awal" class="btn">复制 Awal</button>
              </div>
              <div id="awal-code" class="code"></div>
              <div class="row" style="margin-top:6px;">
                <button id="gen-agentkit" class="btn">生成 AgentKit curl</button>
                <button id="copy-agentkit" class="btn">复制 curl</button>
              </div>
              <div id="agentkit-code" class="code"></div>
              <div class="row" style="margin-top:6px;">
                <button id="verify-btn" class="btn">浏览器校验</button>
                <button id="copy-verify" class="btn">复制校验 curl</button>
              </div>
              <div id="verify-code" class="code"></div>
              <div id="verify-result" class="muted"></div>
            </div>
          </div>
          <div class="card" style="border-bottom:none">
            <div class="muted">说明：此页不接任何外部脚本，仅用于 MVP 测试。</div>
          </div>
        </div>
      </div>
    </div>
    <script>
      var GRID=100,CELL=8,TOTAL=GRID*CELL;
      var canvas=document.getElementById('grid'),ctx=canvas.getContext('2d');
      var state={scale:1,ox:0,oy:0,drag:null,hover:null,selected:{x:24,y:24}};
      var cells=new Map();
      function resize(){var dpr=window.devicePixelRatio||1;var rect=canvas.parentElement.getBoundingClientRect();canvas.width=rect.width*dpr;canvas.height=(rect.height-40)*dpr;canvas.style.width=rect.width+'px';canvas.style.height=(rect.height-40)+'px';ctx.setTransform(dpr,0,0,dpr,0,0);center();draw();}
      function center(){var rect=canvas.getBoundingClientRect();var s=Math.min(rect.width/TOTAL,rect.height/TOTAL)*0.95;state.scale=s;state.ox=(rect.width-TOTAL*s)/2;state.oy=(rect.height-TOTAL*s)/2;}
      function draw(){var rect=canvas.getBoundingClientRect();ctx.fillStyle=getCSS('--bg');ctx.fillRect(0,0,rect.width,rect.height);ctx.save();ctx.translate(state.ox,state.oy);ctx.scale(state.scale,state.scale);ctx.fillStyle='#111827';ctx.fillRect(0,0,TOTAL,TOTAL);ctx.strokeStyle='#1f2937';ctx.lineWidth=0.5;ctx.beginPath();for(var i=0;i<=GRID;i++){ctx.moveTo(i*CELL,0);ctx.lineTo(i*CELL,TOTAL);ctx.moveTo(0,i*CELL);ctx.lineTo(TOTAL,i*CELL);}ctx.stroke();cells.forEach(function(c){ctx.fillStyle=c.color||getCSS('--green');ctx.fillRect(c.x*CELL+0.5,c.y*CELL+0.5,CELL-1,CELL-1);});if(state.hover){ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(state.hover.x*CELL,state.hover.y*CELL,CELL,CELL);}if(state.selected){ctx.strokeStyle='#f43f5e';ctx.lineWidth=2/state.scale;ctx.strokeRect(state.selected.x*CELL-1,state.selected.y*CELL-1,CELL+2,CELL+2);}ctx.restore();updateStats();}
      function updateStats(){var owned=0,sale=0;cells.forEach(function(c){if(c.owned)owned++;if(c.onSale)sale++;});setText('owned',owned);setText('sale',sale);}
      function screenToGrid(cx,cy){var rect=canvas.getBoundingClientRect();var x=(cx-rect.left-state.ox)/state.scale;var y=(cy-rect.top-state.oy)/state.scale;var gx=Math.floor(x/CELL),gy=Math.floor(y/CELL);if(gx>=0&&gx<GRID&&gy>=0&&gy<GRID)return{x:gx,y:gy};return null;}
      function setText(id,t){var el=document.getElementById(id);if(el)el.textContent=String(t);}
      function getCSS(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}
      canvas.addEventListener('mousedown',function(e){state.drag={sx:e.clientX,sy:e.clientY,ox:state.ox,oy:state.oy,moved:false};});
      canvas.addEventListener('mousemove',function(e){if(state.drag){var dx=e.clientX-state.drag.sx,dy=e.clientY-state.drag.sy;if(Math.abs(dx)>2||Math.abs(dy)>2)state.drag.moved=true;state.ox=state.drag.ox+dx;state.oy=state.drag.oy+dy;draw();}state.hover=screenToGrid(e.clientX,e.clientY);if(!state.drag)draw();});
      canvas.addEventListener('mouseup',function(e){if(!state.drag||state.drag.moved){state.drag=null;return;}state.drag=null;var g=screenToGrid(e.clientX,e.clientY);if(g){state.selected=g;renderSide(g);draw();}});
      canvas.addEventListener('mouseleave',function(){state.drag=null;state.hover=null;draw();});
      function renderSide(cell){setText('cell-title','格子 ('+cell.x+', '+cell.y+')');var sub=document.getElementById('cell-sub');if(sub)sub.textContent='金额默认 0.02 USDC';}
      function getVal(id){var el=document.getElementById(id);return el?el.value||'':'';}
      function setCode(id,text){var el=document.getElementById(id);if(el)el.textContent=text;}
      function copy(id){var el=document.getElementById(id);var txt=el?el.textContent||'':'';if(!txt){alert('内容为空');return;}navigator.clipboard.writeText(txt).then(function(){alert('已复制');}).catch(function(){alert('复制失败');});}
      function originBase(){var u=location.origin.replace(/\/$/,'');return u;}
      function genAwal(){var t=getVal('treasury');var a=Number(getVal('amount')||'0.02')||0.02;var cmd=['npx awal auth you@example.com','npx awal send '+a+' '+t].join('\n');setCode('awal-code',cmd);}
      function genAgentKit(){var a=Number(getVal('amount')||'0.02')||0.02;var c=state.selected||{x:24,y:24};var body=JSON.stringify({x:c.x,y:c.y,amount_usdc:a,url:"",mode:"agentkit"}).replace(/'/g,"\\'");var cmd="curl -s -X POST '"+originBase()+"/api/purchase' -H 'Content-Type: application/json' -d '"+body+"'";setCode('agentkit-code',cmd);}
      function genVerify(){var a=Number(getVal('amount')||'0.02')||0.02;var t=getVal('treasury');var tx=getVal('txhash');var url=tx?(originBase()+"/api/purchase/verify?amount_usdc="+a+"&to="+t+"&tx="+tx):(originBase()+"/api/purchase/verify?amount_usdc="+a+"&to="+t+"&lookback=50000");setCode('verify-code',url);}
      function verifyFetch(){var u=document.getElementById('verify-code');var url=u?u.textContent:'';if(!url){genVerify();url=u?u.textContent:'';}var out=document.getElementById('verify-result');if(out)out.textContent='校验中…';try{fetch(url).then(function(r){return r.json();}).then(function(j){var ok=j&&j.paid;var txt=(ok?'已到账 ':'未到账 ')+(j&&j.amount_usdc?('('+j.amount_usdc+' USDC)'):'');if(out){out.innerHTML='<span class="'+(ok?'ok':'fail')+'">'+txt+'</span>';}}).catch(function(){if(out)out.textContent='浏览器校验失败，请用 curl';});}catch(e){if(out)out.textContent='浏览器校验失败，请用 curl';}}
      function bind(id,fn){var el=document.getElementById(id);if(el)el.addEventListener('click',fn);}
      bind('gen-awal',genAwal);bind('copy-awal',function(){copy('awal-code')});
      bind('gen-agentkit',genAgentKit);bind('copy-agentkit',function(){copy('agentkit-code')});
      bind('verify-btn',verifyFetch);bind('copy-verify',function(){copy('verify-code')});
      window.addEventListener('resize',resize);resize();renderSide(state.selected);
    </script>
  </body>
</html>
