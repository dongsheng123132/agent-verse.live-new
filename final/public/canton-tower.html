<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canton Tower Diorama</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #1a1a1a; font-family: system-ui, sans-serif; user-select: none; }
        #canvas-container { width: 100vw; height: 100vh; }
        .tilt-shift-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 25%, rgba(0,0,0,0) 75%, rgba(0,0,0,0.3) 100%);
            z-index: 10;
        }
        #info-bar {
            position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
            z-index: 20; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 12px;
            padding: 8px 16px; color: #fff; font-size: 11px; white-space: nowrap;
            display: flex; align-items: center; gap: 12px;
        }
        #info-bar button {
            background: rgba(255,255,255,0.15); border: none; color: #fff;
            padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 11px;
        }
        #info-bar button:hover { background: rgba(255,255,255,0.25); }
        #guide-toast {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            z-index: 20; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            border: 1px solid rgba(100,180,255,0.3); border-radius: 10px;
            padding: 8px 14px; color: #a0d0ff; font-size: 12px; max-width: 320px;
            text-align: center; display: none;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div class="tilt-shift-overlay"></div>
    <div id="info-bar">
        <span>Canton Tower Diorama</span>
        <button id="toggle-time">Day/Night</button>
        <span style="opacity:0.5">Drag to rotate · Scroll to zoom</span>
    </div>
    <div id="guide-toast"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls, raycaster, mouse;
        let isNight = false;
        let clock = new THREE.Clock();
        let towerOuterMesh, towerInnerMesh;
        let cityGroup;
        let sunLight, hemiLight;

        const COLORS = {
            day:   { sky: 0x87CEEB, fog: 0x90D0F0, sunInt: 1.5, hemiInt: 0.6 },
            night: { sky: 0x050510, fog: 0x020208, sunInt: 0.2, hemiInt: 0.2 }
        };

        const LANDMARKS = [
            "IFC 西塔 — 广州第二高楼，437米，金融中心",
            "CTF 东塔 — 周大福金融中心，530米，广州最高",
            "广州大剧院 — 扎哈·哈迪德设计，双砾石造型",
            "广东省博物馆 — 月光宝盒外形，岭南文化宝库",
            "花城广场 — 广州城市客厅，珠江新城中轴线",
            "海心沙 — 亚运开幕式场地，珠江中的小岛",
            "猎德大桥 — 珠江上的优雅弧线",
            "珠江新城住宅区 — 广州最贵的天际线",
            "广州图书馆 — 南中国最大的公共图书馆",
            "TIT 创意园 — 微信总部所在地"
        ];

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(COLORS.day.sky);
            scene.fog = new THREE.FogExp2(COLORS.day.fog, 0.006);

            camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(60, 45, 60);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, COLORS.day.hemiInt);
            scene.add(hemiLight);

            sunLight = new THREE.DirectionalLight(0xffffee, COLORS.day.sunInt);
            sunLight.position.set(50, 60, -30);
            sunLight.castShadow = true;
            scene.add(sunLight);

            buildWorld();

            window.addEventListener('resize', onResize);
            renderer.domElement.addEventListener('click', onClick);
            document.getElementById('toggle-time').addEventListener('click', toggleDayNight);
        }

        function buildWorld() {
            // Base platform
            const base = new THREE.Mesh(
                new THREE.CylinderGeometry(45, 45, 2, 64),
                new THREE.MeshStandardMaterial({ color: 0x2c3e50 })
            );
            base.position.y = -1;
            base.receiveShadow = true;
            scene.add(base);

            // Canton Tower - inner structure
            const height = 28;
            const innerGeom = new THREE.CylinderGeometry(2, 2.8, height, 32);
            innerGeom.translate(0, height / 2, 0);
            const pos = innerGeom.attributes.position;
            for (let i = 0; i < pos.count; i++) {
                const y = pos.getY(i);
                const scale = 1.0 - 0.4 * Math.sin((y / height) * Math.PI);
                pos.setX(i, pos.getX(i) * scale);
                pos.setZ(i, pos.getZ(i) * scale);
            }
            towerInnerMesh = new THREE.Mesh(innerGeom, new THREE.MeshStandardMaterial({ color: 0xe0e0e0 }));
            scene.add(towerInnerMesh);

            // Canton Tower - outer wireframe
            const outerGeom = new THREE.CylinderGeometry(2.5, 3.5, height, 24, 16);
            outerGeom.translate(0, height / 2, 0);
            const outPos = outerGeom.attributes.position;
            for (let i = 0; i < outPos.count; i++) {
                const y = outPos.getY(i);
                const ny = y / height;
                const angle = ny * Math.PI * 1.2;
                const scale = 1.0 - 0.5 * Math.sin(ny * Math.PI);
                const x = outPos.getX(i), z = outPos.getZ(i);
                outPos.setX(i, (x * Math.cos(angle) - z * Math.sin(angle)) * scale);
                outPos.setZ(i, (x * Math.sin(angle) + z * Math.cos(angle)) * scale);
            }
            towerOuterMesh = new THREE.Mesh(outerGeom, new THREE.MeshStandardMaterial({
                color: 0xaaaaaa, wireframe: true, emissive: 0x000000
            }));
            scene.add(towerOuterMesh);

            // City buildings
            cityGroup = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: 0xe0e6ed });
            const box = new THREE.BoxGeometry(1, 1, 1);
            box.translate(0, 0.5, 0);
            for (let i = 0; i < 150; i++) {
                const a = Math.random() * Math.PI * 2;
                const r = 10 + Math.random() * 30;
                if (Math.sin(a) * r > 13 && Math.sin(a) * r < 27) continue;
                const mesh = new THREE.Mesh(box, mat);
                mesh.position.set(Math.cos(a) * r, 0, Math.sin(a) * r);
                mesh.scale.set(1 + Math.random() * 2, 1 + Math.random() * 10 * (1 - r / 45), 1 + Math.random() * 2);
                mesh.userData = { isBuilding: true, id: i };
                cityGroup.add(mesh);
            }
            scene.add(cityGroup);

            // Pearl River (water plane)
            const river = new THREE.Mesh(
                new THREE.PlaneGeometry(90, 12),
                new THREE.MeshStandardMaterial({ color: 0x3a7ca5, transparent: true, opacity: 0.6 })
            );
            river.rotation.x = -Math.PI / 2;
            river.position.set(0, 0.05, 20);
            scene.add(river);
        }

        function onClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(cityGroup.children);
            if (hits.length > 0) {
                const info = LANDMARKS[hits[0].object.userData.id % LANDMARKS.length];
                const toast = document.getElementById('guide-toast');
                toast.textContent = info;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 4000);
            }
        }

        function toggleDayNight() {
            isNight = !isNight;
            const t = isNight ? COLORS.night : COLORS.day;
            scene.background.setHex(t.sky);
            scene.fog.color.setHex(t.fog);
            sunLight.intensity = t.sunInt;
            hemiLight.intensity = t.hemiInt;
            towerOuterMesh.material.emissiveIntensity = isNight ? 2 : 0;
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (isNight) {
                towerOuterMesh.material.emissive.setHSL((clock.getElapsedTime() * 0.1) % 1.0, 0.8, 0.5);
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
